<?xml version="1.0" encoding="UTF-8"?>

<component name="studio.extensions.easyshare" version="1.0.0">
  <require>org.nuxeo.runtime.started</require>
  <extension target="org.nuxeo.ecm.core.schema.TypeService" point="schema">
    <schema name="easysharefolder" prefix="eshare" src="data/schemas/easysharefolder.xsd"/>
  </extension>
  <extension target="org.nuxeo.ecm.core.schema.TypeService" point="doctype">
    <doctype name="EasyShareFolder" extends="Folder">
      <facet name="Collection"/>
      <facet name="NotCollectionMember"/>
      <schema name="dublincore"/>
      <schema name="common"/>
      <schema name="easysharefolder"/>
      <schema name="uid"/>
    </doctype>
    <doctype name="Folder" append="true">
      <subtypes>
        <type>EasyShareFolder</type>
      </subtypes>
    </doctype>
    <doctype name="Workspace" append="true">
      <subtypes>
        <type>EasyShareFolder</type>
      </subtypes>
    </doctype>
  </extension>
  <extension target="org.nuxeo.ecm.core.lifecycle.LifeCycleService" point="types">
    <types>
      <type name="EasyShareFolder">default</type>
    </types>
  </extension>
  <extension target="org.nuxeo.ecm.platform.types.TypeService" point="types">
    <type id="EasyShareFolder">
      <label>EasyShareFolder</label>
      <category>Collaborative</category>
      <icon>/img/easyshare.png</icon>
      <bigIcon>/img/easyshare_100.png</bigIcon>
      <description>EasyShareFolder.description</description>
      <default-view>view_documents</default-view>
    </type>
  </extension>
  <extension target="org.nuxeo.ecm.platform.actions.ActionService" point="actions">
    <action id="TAB_CONTENT">
      <filter-id>denyForEasyShareFolder</filter-id>
    </action>
    <action id="TAB_VIEW">
      <filter-id>denyForEasyShareFolder</filter-id>
    </action>
    <action id="TAB_RELATIONS">
      <filter-id>denyForEasyShareFolder</filter-id>
    </action>
  </extension>
  <extension target="org.nuxeo.ecm.platform.ec.notification.service.NotificationService" point="notifications">
    <notification name="easyShareDownload" channel="email"
                  enabled="true" availableIn="Workspace" autoSubscribed="true"
                  template="easyShareDownload" subject="EasyShare download notification"
                  subjectTemplate="easyShareDownloadSubject">
      <event name="easyShareDownload"/>
    </notification>
    <notification name="easyShareExpired" channel="email"
                  enabled="true" availableIn="Workspace" autoSubscribed="true"
                  template="easyShareExpired"
                  subject="EasyShare expired notification"
                  subjectTemplate="easyShareExpiredSubject">
      <event name="easyShareExpired"/>
    </notification>
  </extension>
  <extension target="org.nuxeo.ecm.platform.ec.notification.service.NotificationService" point="templates">
    <template name="easyShareDownload" src="templates/easyShareDownload.ftl"/>
    <template name="easyShareExpired" src="templates/easyShareExpired.ftl"/>
    <template name="easyShareDownloadSubject" src="templates/easyShareDownloadSubject.ftl"/>
    <template name="easyShareExpiredSubject" src="templates/easyShareExpiredSubject.ftl"/>
  </extension>
  <extension target="org.nuxeo.ecm.core.operation.OperationServiceComponent" point="chains">
    <chain id="addToAShareDocument">
      <operation id="Seam.GetCurrentDocument"/>
      <operation id="Context.SetInputAsVar">
        <param type="string" name="name">shareDocument</param>
      </operation>
      <operation id="Context.SetVar">
        <param type="string" name="name">shareDocumentPath</param>
        <param type="object" name="value">expr:Document.path</param>
      </operation>
      <operation id="Seam.FetchFromWorklist"/>
      <operation id="CreateProxyLive">
        <param type="string" name="Destination Path">expr:shareDocumentPath</param>
      </operation>
      <operation id="Context.RestoreDocumentInput">
        <param type="string" name="name">shareDocument</param>
      </operation>
      <operation id="Audit.Log">
        <param type="string" name="event">Documents added to the share</param>
        <param type="string" name="category">EasyShareFolderCategory</param>
        <param type="string" name="comment">expr:Some documents were added to the share folder @{Document["dc:title"]}</param>
      </operation>
      <operation id="Seam.Refresh"/>
      <operation id="Seam.AddInfoMessage">
        <param type="string" name="message">Added</param>
      </operation>
    </chain>
    <chain id="navToParent">
      <operation id="Context.FetchDocument"/>
      <operation id="Document.GetParent"/>
      <operation id="Seam.NavigateTo"/>
    </chain>
  </extension>
  <extension target="org.nuxeo.ecm.platform.actions.ActionService" point="filters">
    <filter id="create" append="true">
      <rule grant="true">
        <permission>AddChildren</permission>
        <type>EasyShareFolder</type>
        <condition>!document.isImmutable()</condition>
        <condition>#{typeManager.getAllowedSubTypes(document.getType(), document).size() &gt; 0}</condition>
      </rule>
    </filter>
    <filter id="denyForEasyShareFolder">
      <rule grant="false">
        <type>EasyShareFolder</type>
      </rule>
    </filter>

  </extension>
  <extension target="org.nuxeo.ecm.platform.forms.layout.WebLayoutManager" point="widgettypes">


    <documentation>Widget types declared in studio</documentation>


    <widgetType name="studio_header">

      <configuration>

        <title>Header</title>

        <description>
          The header widget just displays the widget label.
        </description>

        <supportedModes>

          <mode>edit</mode>

          <mode>view</mode>

        </supportedModes>

        <fields>

          <list>false</list>

          <complex>false</complex>

          <supportedTypes/>

          <defaultTypes/>

        </fields>

        <handlingLabels>true</handlingLabels>

        <categories>

          <category>document</category>

          <category>studio</category>

        </categories>

        <properties>

          <layouts mode="any">

            <layout name="studio_header_widget_type_properties_any">

              <rows>

                <row>

                  <widget>styleClass</widget>

                </row>

                <row>

                  <widget>style</widget>

                </row>

              </rows>

              <widget name="styleClass" type="text">

                <labels>

                  <label mode="any">Style class</label>

                </labels>

                <fields>

                  <field>styleClass</field>

                </fields>

              </widget>

              <widget name="style" type="text">

                <labels>

                  <label mode="any">Style</label>

                </labels>

                <fields>

                  <field>style</field>

                </fields>

              </widget>

            </layout>

          </layouts>

        </properties>

      </configuration>

      <handler-class>
        org.nuxeo.ecm.platform.forms.layout.facelets.plugins.TemplateWidgetTypeHandler
      </handler-class>

      <property name="template">
        /widgets/studio_header_widget.xhtml
      </property>

    </widgetType>


    <widgetType name="filesList">

      <configuration>

        <title>Files</title>

        <description>

          <p>
            The Files displays an editable list of files, using javascript to
            keep the uploaded file path when adding several files in a row.
          </p>

          <p>Items are defined using sub wigdets configuration.</p>

          <p>
            This is actually a template widget type whose template uses a
            &lt;nxu:inputList /&gt; tag in edit or create mode, and a table
            iterating over items in other modes.
          </p>

        </description>

        <categories>

          <category>document</category>

          <category>studio</category>

        </categories>

        <supportedModes>

          <mode>edit</mode>

          <mode>view</mode>

        </supportedModes>

        <acceptingSubWidgets>true</acceptingSubWidgets>

        <fields>

          <list>true</list>

          <complex>false</complex>

          <supportedTypes>

            <type>blob</type>

          </supportedTypes>

          <defaultTypes>

            <type>blob</type>

          </defaultTypes>

        </fields>

        <properties>

          <layouts mode="edit">

            <layout name="list_widget_type_properties_edit">

              <rows>

                <row>

                  <widget>required</widget>

                </row>

                <row>

                  <widget>diff</widget>

                </row>

              </rows>

              <widget name="required" type="checkbox">

                <labels>

                  <label mode="any">Required</label>

                </labels>

                <fields>

                  <field>required</field>

                </fields>

              </widget>

              <widget name="diff" type="checkbox">

                <labels>

                  <label mode="any">Diff</label>

                </labels>

                <fields>

                  <field>diff</field>

                </fields>

              </widget>

            </layout>

          </layouts>

        </properties>

      </configuration>

      <handler-class>
        org.nuxeo.ecm.platform.forms.layout.facelets.plugins.TemplateWidgetTypeHandler
      </handler-class>

      <property name="template">/widgets/files_list_widget_template.xhtml
      </property>

    </widgetType>


  </extension>
</component>
